<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>AceAS.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">coverage</a> &gt; <a href="../index.html" class="el_bundle">AceAS</a> &gt; <a href="index.source.html" class="el_package">eu.sifishome</a> &gt; <span class="el_source">AceAS.java</span></div><h1>AceAS.java</h1><pre class="source lang-java linenums">package eu.sifishome;

import COSE.*;
import it.cnr.iit.ucs.properties.components.PipProperties;
import it.cnr.iit.xacml.Category;
import it.cnr.iit.xacml.DataType;
import jakarta.websocket.DeploymentException;
import org.eclipse.californium.core.coap.CoAP;
import org.glassfish.tyrus.client.ClientManager;
import se.sics.ace.*;
import se.sics.ace.as.PDP;
import se.sics.ace.as.TrlConfig;
import se.sics.ace.as.logging.DhtLogger;
import se.sics.ace.coap.as.CoapDBConnector;
import se.sics.ace.coap.as.OscoreAS;
import se.sics.ace.examples.KissPDP;
import se.sics.ace.examples.KissTime;

import se.sics.ace.ucs.UcsHelper;
import se.sics.ace.ucs.properties.UcsPapProperties;
import se.sics.ace.ucs.properties.UcsPipReaderProperties;

import java.io.*;
import java.net.URI;
import java.net.URISyntaxException;
import java.net.URL;
import java.nio.charset.StandardCharsets;

import java.util.*;
import java.util.concurrent.Callable;
import java.util.stream.Collectors;

import picocli.CommandLine;
import picocli.CommandLine.Command;
import picocli.CommandLine.Option;
import picocli.CommandLine.ArgGroup;

import eu.sifishome.peers.Client;
import eu.sifishome.peers.ResourceServer;

import static java.lang.Thread.sleep;

/**
 * Authorization Server to test with AceClient and AceRS
 *
 * @author Marco Rasori
 *
 */
@Command(name = &quot;a-server&quot;,
        mixinStandardHelpOptions = true,
        version = &quot;1.0&quot;,
        description = &quot;Runs the ACE Authorization Server.\n&quot; +
                &quot;The default PDP is the UCS&quot;)
<span class="fc" id="L54">public class AceAS implements Callable&lt;Integer&gt; {</span>

    private final static String DEFAULT_CLIENT_NAME = &quot;ClientA&quot;;
    private final static String DEFAULT_RESOURCE_SERVER_NAME = &quot;rs1&quot;;
    private final static String DEFAULT_CLIENT_SCOPE = &quot;r_temp r_helloWorld&quot;;
    private final static String DEFAULT_RESOURCE_SERVER_SCOPE = &quot;r_temp r_helloWorld&quot;;
    private final static String DEFAULT_CLIENT_AUD = &quot;rs1&quot;;
    // the AS automatically adds an audience with the resource server name
    private final static String DEFAULT_RESOURCE_SERVER_AUD = DEFAULT_RESOURCE_SERVER_NAME;
    private final static String DEFAULT_CLIENT_SENDER_ID = &quot;0x22&quot;;
    private final static String DEFAULT_RESOURCE_SERVER_SENDER_ID = &quot;0x11&quot;;
    private final static String DEFAULT_CLIENT_MASTER_SECRET =
            &quot;ClientA-AS-MS---&quot;;
    private final static String DEFAULT_RESOURCE_SERVER_MASTER_SECRET =
            &quot;RS1-AS-MS-------&quot;; //16-byte long
    private final static String DEFAULT_RESOURCE_SERVER_TOKEN_PSK =
            &quot;RS1-AS-Default-PSK-for-tokens---&quot;; //32-byte long

    private final static String DEFAULT_RESOURCES = &quot;Temp HelloWorld&quot;;
    private final static String DEFAULT_DHT_ADDRESS = &quot;ws://localhost:3000/ws&quot;;
    private final static String DEFAULT_DBURI = &quot;jdbc:mysql://localhost:3306&quot;;

    @Option(names = {&quot;-d&quot;, &quot;--dbUri&quot;},
            required = false,
            defaultValue = DEFAULT_DBURI,
            description = &quot;The URI of the sql database.\n&quot; +
                    &quot;Hostname and port MUST be specified.\n&quot; +
                    &quot;Optionally, admin credentials can be specified \n&quot; +
                    &quot;in the form username:password within the URI, e.g., \n&quot; +
                    &quot;jdbc:mysql://username:password@host:port \n&quot; +
                    &quot;(default: ${DEFAULT-VALUE})\n&quot;)
    private String dbUri;

<span class="nc" id="L87">    static class DhtArgs {</span>
<span class="nc" id="L88">        @Option(names = {&quot;-D&quot;, &quot;--dht&quot;},</span>
                required = true,
                description = &quot;Enable DHT.\n&quot;)
        boolean isDhtEnabled = false;

        @Option(names = {&quot;-w&quot;, &quot;--websocketuri&quot;},
                required = false,
                defaultValue = DEFAULT_DHT_ADDRESS,
                description = &quot;The URI of the websocket where the DHT process is listening.\n&quot; +
                        &quot;(default: ${DEFAULT-VALUE})\n&quot;)
        String dhtUri;
    }


    @Option(names = {&quot;-K&quot;, &quot;--Kisspdp&quot;},
            required = false,
            description = &quot;Use the KissPDP as PDP.\n&quot; +
                    &quot;(default: UCS)\n&quot;)
    private boolean isKissPDP;

<span class="fc" id="L108">    @Option(names = {&quot;-N&quot;, &quot;--numberOfAttributes&quot;},</span>
            required = false,
            description = &quot;Number of mutable attributes of the policies containing 'r_temp' and 'r_helloWorld' &quot; +
                    &quot;subscopes.&quot;)
    public int numAttributes = 1;

    @Option(names = {&quot;-Y&quot;, &quot;--resources&quot;},
            required = false,
            description = &quot;List of resources managed by the AS. Possible values: 'Brightness', 'HelloWorld', &quot; +
                    &quot;'Humidity', 'Temp', and 'Volume'.\n&quot; +
                    &quot;(default: '&quot; + DEFAULT_RESOURCES + &quot;')&quot;)
    String resources;

<span class="fc" id="L121">    static class Opt {</span>
        @Option(names = {&quot;-n&quot;, &quot;--name&quot;},
                required = true,
                description = &quot;The peer name.\n&quot; +
                        &quot;(default: '&quot; + DEFAULT_CLIENT_NAME + &quot;' for the Client;\n&quot; +
                        &quot;          '&quot; + DEFAULT_RESOURCE_SERVER_NAME + &quot;' for the Resource Server)&quot;)
        String name;

        @Option(names = {&quot;-s&quot;, &quot;--scope&quot;},
                required = true,
                description = &quot;The scope.\n&quot; +
                        &quot;(default: '&quot; + DEFAULT_CLIENT_SCOPE + &quot;' for the Client;\n&quot; +
                        &quot;          '&quot; + DEFAULT_RESOURCE_SERVER_SCOPE + &quot;' for the Resource Server)&quot;)
        List&lt;String&gt; scope;

        @Option(names = {&quot;-u&quot;, &quot;--aud&quot;},
                required = true,
                description = &quot;The audience.\n&quot; +
                        &quot;(default: '&quot; + DEFAULT_CLIENT_AUD + &quot;' for the Client;\n&quot; +
                        &quot;          '&quot; + DEFAULT_RESOURCE_SERVER_AUD + &quot;' for the Resource Server)&quot;)
        List&lt;String&gt; aud;

        @Option(names = {&quot;-x&quot;, &quot;--senderId&quot;},
                required = true,
                description = &quot;The Sender ID in HEX used for &quot; +
                        &quot;the OSCORE Security Context with the Authorization Server.\n&quot; +
                        &quot;(default: '&quot; + DEFAULT_CLIENT_SENDER_ID + &quot;' for the Client;\n&quot; +
                        &quot;          '&quot; + DEFAULT_RESOURCE_SERVER_SENDER_ID + &quot;' for the Resource Server)&quot;)
        String sId;

        @Option(names = {&quot;-m&quot;, &quot;--mastersecret&quot;},
                required = true,
                description = &quot;The symmetric pre-shared key between &quot; +
                        &quot;the Authorization Server and the peer. It is the master &quot; +
                        &quot;secret used for the OSCORE Security Context.\n&quot; +
                        &quot;(default: '&quot; + DEFAULT_CLIENT_MASTER_SECRET + &quot;' for the Client;\n&quot; +
                        &quot;          '&quot; + DEFAULT_RESOURCE_SERVER_MASTER_SECRET + &quot;' for the Resource Server)&quot;)
        String key;

        @Option(names = {&quot;-k&quot;, &quot;--key&quot;},
                required = false,
                defaultValue = DEFAULT_RESOURCE_SERVER_TOKEN_PSK,
                description = &quot;The symmetric pre-shared key between the Resource &quot; +
                        &quot;Server and the Authorization Server. It is used by the &quot; +
                        &quot;Authorization Server to protect the tokens for this &quot; +
                        &quot;Resource Server.\n&quot; +
                        &quot;(default: ${DEFAULT-VALUE})\n&quot;)
        String tokenKey;
    }

<span class="fc" id="L171">    static class Peer {</span>
        @Option(names = {&quot;-C&quot;, &quot;--Client&quot;},
                required = true,
                description = &quot;Add a new Client&quot;)
        boolean isClient;

        @Option(names = {&quot;-R&quot;, &quot;--Resourceserver&quot;},
                required = true,
                description = &quot;Add a new Resource Server&quot;)
        boolean isResourceServer;
    }

<span class="fc" id="L183">    static class Args {</span>
        @ArgGroup(exclusive = true, multiplicity = &quot;1&quot;)
        Peer peer;

        @ArgGroup(exclusive = false, multiplicity = &quot;1&quot;)
        Opt opt;

    }

    @ArgGroup(exclusive = false, multiplicity = &quot;0..*&quot;)
    List&lt;AceAS.Args&gt; args;

    @ArgGroup(exclusive = false)
    DhtArgs dhtArg;

    static OneKey myAsymmKey;

<span class="fc" id="L200">    private static CoapDBConnector db = null;</span>
<span class="fc" id="L201">    private static OscoreAS as = null;</span>
    private static PDP pdp;

<span class="fc" id="L204">    private final static Map&lt;String, String&gt; peerNamesToIdentities = new HashMap&lt;&gt;();</span>
<span class="fc" id="L205">    private final static Map&lt;String, String&gt; peerIdentitiesToNames = new HashMap&lt;&gt;();</span>
<span class="fc" id="L206">    private final static Map&lt;String, String&gt; myIdentities = new HashMap&lt;&gt;();</span>
<span class="fc" id="L207">    private final static byte[] idContext = new byte[]{0x44};</span>

<span class="fc" id="L209">    static String asName = &quot;AS&quot;;</span>
<span class="fc" id="L210">    private final String asIdentity = buildOscoreIdentity(new byte[]{0x33}, idContext);</span>

    private static Timer timer;

<span class="fc" id="L214">    private static final File attributesDir = new File(Utils.getResourcePath(AceAS.class), &quot;attributes&quot;);</span>
<span class="fc" id="L215">    private static final File policiesDir = new File(Utils.getResourcePath(AceAS.class), &quot;policies&quot;);</span>
    private boolean isDhtEnabled;
    private String dhtAddr;


    //--- MAIN
    public static void main(String[] args) {

<span class="nc" id="L223">        int exitCode = new CommandLine(new AceAS()).execute(args);</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">        if (exitCode != 0) {</span>
<span class="nc" id="L225">            as.stop();</span>
<span class="nc" id="L226">            System.exit(exitCode);</span>
        }
<span class="nc" id="L228">    }</span>


    @Override
    public Integer call() throws Exception {

<span class="fc" id="L234">        Utils.createDir(attributesDir);</span>
<span class="fc" id="L235">        Utils.createDir(policiesDir);</span>

<span class="fc" id="L237">        parseNumAttributes();</span>
<span class="fc" id="L238">        parseResources();</span>

<span class="fc" id="L240">        DBHelper.setUpDB(dbUri);</span>
<span class="fc" id="L241">        db = DBHelper.getCoapDBConnector();</span>

<span class="fc" id="L243">        setupPDP();</span>

<span class="fc" id="L245">        parseInputs();</span>

<span class="fc" id="L247">        KissTime time = new KissTime();</span>

<span class="fc" id="L249">        TrlConfig trlConfig = new TrlConfig(&quot;trl&quot;, 3, null, true);</span>

<span class="fc" id="L251">        as = new OscoreAS(asName, db, pdp, time, myAsymmKey, &quot;token&quot;, &quot;introspect&quot;, trlConfig,</span>
                CoAP.DEFAULT_COAP_PORT, null, false, (short) 1, true,
                peerNamesToIdentities, peerIdentitiesToNames, myIdentities);

<span class="fc" id="L255">        as.start();</span>
<span class="fc" id="L256">        System.out.println(&quot;Server starting&quot;);</span>
        //as.stop();

<span class="fc" id="L259">        timer = new Timer();</span>
<span class="fc" id="L260">        timer.schedule(new AttributeChanger(&quot;thermometer-reachable.txt&quot;, &quot;changedValue&quot;),</span>
                30000);// + (int) (Math.random() * 30000));

<span class="fc" id="L263">        return 0;</span>
    }

    /**
     * Stops the server
     *
     * @throws Exception
     */
    public static void stop() throws Exception {
<span class="fc" id="L272">        as.stop();</span>
<span class="fc" id="L273">        pdp.close();</span>
<span class="fc" id="L274">        DBHelper.tearDownDB();</span>
<span class="fc" id="L275">        System.out.println(&quot;Server stopped&quot;);</span>
<span class="fc" id="L276">    }</span>


    private void parseInputs() throws AceException {

        List&lt;Args&gt; inputClients;
        try {
<span class="fc" id="L283">            inputClients = new ArrayList&lt;&gt;(this.args);</span>
<span class="fc" id="L284">            inputClients.removeIf(c -&gt; c.peer.isResourceServer);</span>
<span class="fc" id="L285">        } catch (NullPointerException e) {</span>
<span class="fc" id="L286">            inputClients = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L287">        }</span>

        List&lt;Args&gt; inputResourceServers;
        try {
<span class="fc" id="L291">            inputResourceServers = new ArrayList&lt;&gt;(this.args);</span>
<span class="fc" id="L292">            inputResourceServers.removeIf(r -&gt; r.peer.isClient);</span>
<span class="fc" id="L293">        } catch (NullPointerException e) {</span>
<span class="fc" id="L294">            inputResourceServers = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L295">        }</span>

<span class="fc" id="L297">        List&lt;Client&gt; clients = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L298" title="All 2 branches covered.">        if (inputClients.isEmpty()) {</span>
<span class="fc" id="L299">            clients.add(new Client(DEFAULT_CLIENT_NAME, new ArrayList&lt;String&gt;() {{</span>
<span class="fc" id="L300">                add(DEFAULT_CLIENT_SCOPE);</span>
<span class="fc" id="L301">            }},</span>
<span class="fc" id="L302">                    new ArrayList&lt;String&gt;() {{</span>
<span class="fc" id="L303">                        add(DEFAULT_CLIENT_AUD);</span>
<span class="fc" id="L304">                    }}, DEFAULT_CLIENT_SENDER_ID,</span>
                    DEFAULT_CLIENT_MASTER_SECRET));
        }
<span class="fc bfc" id="L307" title="All 2 branches covered.">        for (Args c : inputClients) {</span>
<span class="fc" id="L308">            clients.add(new Client(c.opt.name, c.opt.scope, c.opt.aud,</span>
                    c.opt.sId, c.opt.key));
<span class="fc" id="L310">        }</span>
<span class="fc bfc" id="L311" title="All 2 branches covered.">        for (Client c : clients) {</span>
<span class="fc" id="L312">            setupClient(c);</span>
<span class="fc" id="L313">        }</span>

<span class="fc" id="L315">        List&lt;ResourceServer&gt; resourceServers = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L316" title="All 2 branches covered.">        if (inputResourceServers.isEmpty()) {</span>
<span class="fc" id="L317">            resourceServers.add(new ResourceServer(DEFAULT_RESOURCE_SERVER_NAME,</span>
                    DEFAULT_RESOURCE_SERVER_SCOPE, DEFAULT_RESOURCE_SERVER_AUD,
                    DEFAULT_RESOURCE_SERVER_SENDER_ID, DEFAULT_RESOURCE_SERVER_MASTER_SECRET,
                    DEFAULT_RESOURCE_SERVER_TOKEN_PSK));
        }
<span class="fc bfc" id="L322" title="All 2 branches covered.">        for (Args r : inputResourceServers) {</span>

            // check that all the options have been specified

            // if the resource server name is specified within the audience, remove it
            // (The AS automatically adds an audience with the resource server name for the resource server)
<span class="pc bpc" id="L328" title="1 of 2 branches missed.">            if (r.opt.aud.get(0).contains(r.opt.name)) {</span>
<span class="fc" id="L329">                r.opt.aud.set(0, r.opt.aud.get(0).replaceAll(r.opt.name, &quot;&quot;));</span>
<span class="fc" id="L330">                r.opt.aud.set(0, r.opt.aud.get(0).trim().replaceAll(&quot; +&quot;, &quot; &quot;));</span>
            }
<span class="fc" id="L332">            resourceServers.add(new ResourceServer(r.opt.name, r.opt.scope.get(0), r.opt.aud.get(0),</span>
                    r.opt.sId, r.opt.key, r.opt.tokenKey));
<span class="fc" id="L334">        }</span>
<span class="fc bfc" id="L335" title="All 2 branches covered.">        for (ResourceServer r : resourceServers) {</span>
<span class="fc" id="L336">            setupResourceServer(r);</span>
<span class="fc" id="L337">        }</span>

        // parse DHT arguments
        try {
<span class="nc" id="L341">            isDhtEnabled = this.dhtArg.isDhtEnabled;</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">            if (isDhtEnabled) {</span>
                try {
<span class="nc" id="L344">                    dhtAddr = this.dhtArg.dhtUri;</span>
<span class="nc" id="L345">                } catch (NullPointerException e) {</span>
<span class="nc" id="L346">                    dhtAddr = DEFAULT_DHT_ADDRESS;</span>
<span class="nc" id="L347">                }</span>
            }
<span class="fc" id="L349">        } catch (NullPointerException e) {</span>
<span class="fc" id="L350">            isDhtEnabled = false;</span>
<span class="fc" id="L351">            dhtAddr = DEFAULT_DHT_ADDRESS;</span>
<span class="nc" id="L352">        }</span>
<span class="pc bpc" id="L353" title="1 of 2 branches missed.">        if (isDhtEnabled) {</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">            if (!Utils.isDhtReachable(dhtAddr, 2000, Integer.MAX_VALUE)) {</span>
<span class="nc" id="L355">                throw new AceException(&quot;Unable to connect to the DHT&quot;);</span>
            }
            // Possibly set up connection to the DHT for sending logging statements
<span class="nc" id="L358">            System.out.println(&quot;Connecting to the DHT for logging.&quot;);</span>
<span class="nc" id="L359">            DhtLogger.setLogging(true);</span>
<span class="nc" id="L360">            DhtLogger.establishConnection(dhtAddr);</span>
        }

<span class="fc" id="L363">    }</span>

    private void parseNumAttributes() {
<span class="pc bpc" id="L366" title="1 of 2 branches missed.">        if (numAttributes &lt; 1) {</span>
<span class="nc" id="L367">            System.out.println(&quot;Number of attributes &quot; + numAttributes + &quot; not supported.\n&quot; +</span>
                    &quot;Setting it to the minimum allowed, i.e., 1&quot;);
<span class="nc" id="L369">            numAttributes = 1;</span>
        }
<span class="pc bpc" id="L371" title="1 of 2 branches missed.">        if (numAttributes &gt; 50) {</span>
<span class="nc" id="L372">            System.out.println(&quot;Number of attributes &quot; + numAttributes + &quot; not supported.\n&quot; +</span>
                    &quot;Setting it to the maximum allowed, i.e., 50&quot;);
<span class="nc" id="L374">            numAttributes = 50;</span>
        }
<span class="fc" id="L376">    }</span>

    private void parseResources() {
<span class="pc bpc" id="L379" title="1 of 4 branches missed.">        if (resources == null || resources.isEmpty()) {</span>
<span class="fc" id="L380">            resources = DEFAULT_RESOURCES;</span>
        } else {
            // validate input
        }
<span class="fc" id="L384">    }</span>

    private void setupResourceServer(ResourceServer r) throws AceException {

<span class="fc" id="L388">        db.addRS(r.getName(), r.getProfiles(), r.getScopeSet(), r.getAudSet(),</span>
<span class="fc" id="L389">                r.getKeyTypes(), r.getTokenTypes(), r.getCose(), r.getExpiration(),</span>
<span class="fc" id="L390">                r.getSharedPsk(), r.getTokenPsk(), null);</span>
<span class="fc" id="L391">        addIdentity(r.getName(), r.getsId());</span>
<span class="fc" id="L392">        pdp.addIntrospectAccess(r.getName());</span>
<span class="fc" id="L393">    }</span>

    private void setupClient(Client c) throws AceException {

<span class="fc" id="L397">        db.addClient(c.getName(), c.getProfiles(), null, null,</span>
<span class="fc" id="L398">                c.getKeyTypes(), c.getSharedPsk(), null);</span>
<span class="fc" id="L399">        addIdentity(c.getName(), c.getsId());</span>
<span class="fc" id="L400">        pdp.addTokenAccess(c.getName());</span>

<span class="fc bfc" id="L402" title="All 2 branches covered.">        for (int i = 0; i &lt; c.getScope().size(); i++) {</span>
<span class="fc" id="L403">            String scope = c.getScope().get(i);</span>
<span class="fc" id="L404">            List&lt;String&gt; scopes = new ArrayList&lt;&gt;(Arrays.asList(scope.split(&quot; &quot;)));</span>
<span class="fc bfc" id="L405" title="All 2 branches covered.">            for (String subScope : scopes) {</span>
<span class="fc bfc" id="L406" title="All 2 branches covered.">                if (pdp instanceof UcsHelper) {</span>
<span class="fc" id="L407">                    String res = subScope.substring(subScope.indexOf(&quot;_&quot;) + 1);</span>
<span class="fc" id="L408">                    String policySuffix = &quot;&quot;;</span>
<span class="fc bfc" id="L409" title="All 4 branches covered.">                    if (res.equals(&quot;temp&quot;) &amp;&amp; numAttributes &gt; 1) {</span>
<span class="fc" id="L410">                        policySuffix = &quot;_&quot; + numAttributes + &quot;_attributes&quot;;</span>
                    }
//                    if (res.equals(&quot;helloWorld&quot;) &amp;&amp; numAttributes &gt; 1) {
//                        policySuffix = &quot;_&quot; + numAttributes + &quot;_attributes&quot;;
//                    }
<span class="fc" id="L415">                    String policyTemplate = Utils.readContent(Utils.accessFile(AceAS.class,</span>
                            &quot;policy-templates&quot; + File.separator + &quot;policy_template_&quot; + res + policySuffix));
<span class="fc" id="L417">                    ((UcsHelper) pdp).addAccess(c.getName(), c.getAud().get(i), subScope, policyTemplate);</span>
<span class="fc" id="L418">                } else {</span>
<span class="fc" id="L419">                    pdp.addAccess(c.getName(), c.getAud().get(i), subScope);</span>
                }
<span class="fc" id="L421">            }</span>
        }
<span class="fc" id="L423">    }</span>


    private void addIdentity(String peerName, byte[] peerIdentity) {

<span class="fc" id="L428">        String peerIdentityStr = buildOscoreIdentity(peerIdentity, idContext);</span>
<span class="fc" id="L429">        peerNamesToIdentities.put(peerName, peerIdentityStr);</span>
<span class="fc" id="L430">        peerIdentitiesToNames.put(peerIdentityStr, peerName);</span>
<span class="fc" id="L431">        myIdentities.put(peerName, asIdentity);</span>
<span class="fc" id="L432">    }</span>

    private String buildOscoreIdentity(byte[] senderId, byte[] contextId) {

<span class="pc bpc" id="L436" title="1 of 2 branches missed.">        if (senderId == null)</span>
<span class="nc" id="L437">            return null;</span>
<span class="fc" id="L438">        String identity = &quot;&quot;;</span>

<span class="pc bpc" id="L440" title="1 of 2 branches missed.">        if (contextId != null) {</span>
<span class="fc" id="L441">            identity += Base64.getEncoder().encodeToString(contextId);</span>
<span class="fc" id="L442">            identity += &quot;:&quot;;</span>
        }
<span class="fc" id="L444">        identity += Base64.getEncoder().encodeToString(senderId);</span>

<span class="fc" id="L446">        return identity;</span>

    }


    private void setupPDP() throws AceException {

<span class="fc bfc" id="L453" title="All 2 branches covered.">        if (isKissPDP) {</span>
<span class="fc" id="L454">            pdp = new KissPDP(db);</span>
        } else {

<span class="fc" id="L457">            restoreAttributesValue();</span>

<span class="fc" id="L459">            List&lt;String&gt; allowedResources = new ArrayList&lt;&gt;(Arrays.asList(resources.split(&quot; &quot;)));</span>

<span class="fc" id="L461">            UcsPipReaderProperties pipReader = new UcsPipReaderProperties();</span>
<span class="fc" id="L462">            List&lt;PipProperties&gt; pipPropertiesList = new ArrayList&lt;&gt;();</span>

<span class="pc bpc" id="L464" title="1 of 2 branches missed.">            if (allowedResources.contains(&quot;Temp&quot;)) {</span>
<span class="fc" id="L465">                pipReader.addAttribute(</span>
                        &quot;urn:oasis:names:tc:xacml:3.0:environment:thermometer-reachable&quot;,
<span class="fc" id="L467">                        Category.ENVIRONMENT.toString(),</span>
<span class="fc" id="L468">                        DataType.STRING.toString(),</span>
<span class="fc" id="L469">                        attributesDir.getAbsolutePath() + File.separator +  &quot;thermometer-reachable.txt&quot;);</span>
<span class="fc" id="L470">                pipReader.setRefreshRate(10L);</span>
<span class="fc" id="L471">                pipPropertiesList.add(pipReader);</span>

                //add additional PIPs as specified by the -N option
<span class="fc bfc" id="L474" title="All 2 branches covered.">                for (int i = 2; i &lt;= numAttributes; i++) {</span>
<span class="fc" id="L475">                    pipPropertiesList.add(preparePIPReader(&quot;attribute-temp&quot; + i));</span>
                }
            }

<span class="fc bfc" id="L479" title="All 2 branches covered.">            if (allowedResources.contains(&quot;Humidity&quot;)) {</span>
                // used only for warm up, if the Client uses the -W option
<span class="fc" id="L481">                pipReader = new UcsPipReaderProperties();</span>
<span class="fc" id="L482">                pipReader.addAttribute(</span>
                        &quot;urn:oasis:names:tc:xacml:3.0:environment:hygrometer-reachable&quot;,
<span class="fc" id="L484">                        Category.ENVIRONMENT.toString(),</span>
<span class="fc" id="L485">                        DataType.STRING.toString(),</span>
<span class="fc" id="L486">                        attributesDir.getAbsolutePath() + File.separator +  &quot;hygrometer-reachable.txt&quot;);</span>
<span class="fc" id="L487">                pipPropertiesList.add(pipReader);</span>
            }

<span class="fc bfc" id="L490" title="All 2 branches covered.">            if (allowedResources.contains(&quot;Brightness&quot;)) {</span>
<span class="fc" id="L491">                pipReader = new UcsPipReaderProperties();</span>
<span class="fc" id="L492">                pipReader.addAttribute(</span>
                        &quot;urn:oasis:names:tc:xacml:3.0:environment:screen-reachable&quot;,
<span class="fc" id="L494">                        Category.ENVIRONMENT.toString(),</span>
<span class="fc" id="L495">                        DataType.STRING.toString(),</span>
<span class="fc" id="L496">                        attributesDir.getAbsolutePath() + File.separator + &quot;screen-reachable.txt&quot;);</span>
<span class="fc" id="L497">                pipPropertiesList.add(pipReader);</span>
            }

<span class="fc bfc" id="L500" title="All 2 branches covered.">            if (allowedResources.contains(&quot;Volume&quot;)) {</span>
<span class="fc" id="L501">                pipReader = new UcsPipReaderProperties();</span>
<span class="fc" id="L502">                pipReader.addAttribute(</span>
                        &quot;urn:oasis:names:tc:xacml:3.0:environment:speaker-reachable&quot;,
<span class="fc" id="L504">                        Category.ENVIRONMENT.toString(),</span>
<span class="fc" id="L505">                        DataType.STRING.toString(),</span>
<span class="fc" id="L506">                        attributesDir.getAbsolutePath() + File.separator +  &quot;speaker-reachable.txt&quot;);</span>
<span class="fc" id="L507">                pipPropertiesList.add(pipReader);</span>
            }

<span class="pc bpc" id="L510" title="1 of 2 branches missed.">            if (allowedResources.contains(&quot;HelloWorld&quot;)) {</span>
<span class="fc" id="L511">                pipReader = new UcsPipReaderProperties();</span>
<span class="fc" id="L512">                pipReader.addAttribute(</span>
                        &quot;urn:oasis:names:tc:xacml:3.0:environment:welcome-led-panel&quot;,
<span class="fc" id="L514">                        Category.ENVIRONMENT.toString(),</span>
<span class="fc" id="L515">                        DataType.STRING.toString(),</span>
<span class="fc" id="L516">                        attributesDir.getAbsolutePath() + File.separator + &quot;welcome-led-panel.txt&quot;);</span>
<span class="fc" id="L517">                pipPropertiesList.add(pipReader);</span>
            }

            // code to add a PIPReader monitoring the role of the subject
//            pipReader = new UcsPipReaderProperties();
//            pipReader.addAttribute(
//                    &quot;urn:oasis:names:tc:xacml:1.0:subject:role&quot;,
//                    Category.SUBJECT.toString(),
//                    DataType.STRING.toString(),
//                    attributesDir.getAbsolutePath() + File.separator + &quot;role.txt&quot;);
//            pipPropertiesList.add(pipReader);

//            for (int i = 2; i &lt;= numAttributes; i++) {
//                pipPropertiesList.add(preparePIPReader(&quot;attribute-helloWorld&quot; + i));
//            }

<span class="fc" id="L533">            UcsPapProperties papProperties = new UcsPapProperties(policiesDir.getAbsolutePath());</span>

<span class="fc" id="L535">            String policyTemplate = Utils.readContent(Utils.accessFile(AceAS.class,</span>
                    &quot;policy-templates&quot; + File.separator + &quot;policy_template&quot;));

<span class="fc" id="L538">            pdp = new UcsHelper(db, pipPropertiesList, papProperties, policyTemplate);</span>
        }
<span class="fc" id="L540">    }</span>

    private void restoreAttributesValue() {

        // restore the value of the attributes
<span class="fc" id="L545">        setAttributeValue(attributesDir.getAbsolutePath() + File.separator</span>
                + &quot;hygrometer-reachable.txt&quot;, &quot;y&quot;);

<span class="fc" id="L548">        setAttributeValue(attributesDir.getAbsolutePath() + File.separator</span>
                + &quot;screen-reachable.txt&quot;, &quot;y&quot;);

<span class="fc" id="L551">        setAttributeValue(attributesDir.getAbsolutePath() + File.separator</span>
                + &quot;speaker-reachable.txt&quot;, &quot;y&quot;);

<span class="fc" id="L554">        setAttributeValue(attributesDir.getAbsolutePath() + File.separator</span>
                + &quot;thermometer-reachable.txt&quot;, &quot;y&quot;);

<span class="fc" id="L557">        setAttributeValue(attributesDir.getAbsolutePath() + File.separator</span>
                + &quot;welcome-led-panel.txt&quot;, &quot;Hi!&quot;);

//        setAttributeValue(attributesDir.getAbsolutePath() + File.separator
//                + &quot;role.txt&quot;,
//                &quot;ClientB maintainer\n&quot;
//                        + &quot;ClientC developer\n&quot;
//                        + &quot;ClientA maintainer\n&quot;
//                        + &quot;ClientD admin&quot;);

<span class="fc bfc" id="L567" title="All 2 branches covered.">        for (int i = 2; i &lt;= numAttributes; i++) {</span>
<span class="fc" id="L568">            setAttributeValue(attributesDir.getAbsolutePath() + File.separator</span>
                    + &quot;attribute-temp&quot; + i + &quot;.txt&quot;, &quot;y&quot;);
        }

//        for (int i = 2; i &lt;= numAttributes; i++) {
//            setAttributeValue(attributesDir.getAbsolutePath() + File.separator
//                    + &quot;attribute-helloWorld&quot; + i + &quot;.txt&quot;, &quot;y&quot;);
//        }
<span class="fc" id="L576">    }</span>

    public static UcsPipReaderProperties preparePIPReader(String attribute) {
<span class="fc" id="L579">        UcsPipReaderProperties pipReader = new UcsPipReaderProperties();</span>
<span class="fc" id="L580">        pipReader.addAttribute(</span>
                &quot;urn:oasis:names:tc:xacml:3.0:environment:&quot; + attribute,
<span class="fc" id="L582">                Category.ENVIRONMENT.toString(),</span>
<span class="fc" id="L583">                DataType.STRING.toString(),</span>
<span class="fc" id="L584">                attributesDir.getAbsolutePath() + File.separator + attribute + &quot;.txt&quot;);</span>
<span class="fc" id="L585">        return pipReader;</span>
    }

    public static void setAttributeValue(String fileName, String value) {

<span class="fc" id="L590">        File file = new File(fileName);</span>
<span class="fc" id="L591">        FileWriter fw = null;</span>
        try {
<span class="fc" id="L593">            fw = new FileWriter(file);</span>
<span class="fc" id="L594">            fw.write(value);</span>
<span class="fc" id="L595">            fw.close();</span>
<span class="nc" id="L596">        } catch (IOException e) {</span>
<span class="nc" id="L597">            e.printStackTrace();</span>
<span class="fc" id="L598">        }</span>
<span class="fc" id="L599">    }</span>

    /**
     * Change the attribute value within the file identified by fileName.
     * This triggers the possible revocation of tokens for the policies
     * that include that attribute.
     */
    public static class AttributeChanger extends TimerTask {

        private final String fileName;
        private final String value;

<span class="fc" id="L611">        public AttributeChanger(String fileName, String value) {</span>
<span class="fc" id="L612">            this.fileName = fileName;</span>
<span class="fc" id="L613">            this.value = value;</span>
<span class="fc" id="L614">        }</span>

        public void run() {
<span class="nc" id="L617">            File file = new File(attributesDir.getAbsolutePath() + File.separator</span>
                    + this.fileName);
<span class="nc" id="L619">            FileWriter fw = null;</span>
            try {
<span class="nc" id="L621">                fw = new FileWriter(file);</span>
<span class="nc" id="L622">                fw.write(this.value);</span>
<span class="nc" id="L623">                fw.close();</span>
<span class="nc" id="L624">            } catch (IOException e) {</span>
<span class="nc" id="L625">                e.printStackTrace();</span>
<span class="nc" id="L626">            }</span>
<span class="nc" id="L627">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>